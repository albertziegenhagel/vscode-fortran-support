# What's New (PRE RELEASE) <!-- omit in toc -->

## üéâ Modern Fortran Release Nightly üéâ! <!-- omit in toc -->

- [Linter](#linter)
  - [`fypp` support](#fypp-support)
  - [Improved diagnostics for GNU Fortran](#improved-diagnostics-for-gnu-fortran)
  - [LFortran Linter support](#lfortran-linter-support)
  - [Persistent Cache](#persistent-cache)
  - [Commands](#commands)
- [User Interface (UI)](#user-interface-ui)
  - [Run and Debug individual files](#run-and-debug-individual-files)
  - [Log Channel improvements](#log-channel-improvements)
  - [Setting verbosity level](#setting-verbosity-level)
  - [Added Fortran Logo icon](#added-fortran-logo-icon)
  - [Added relative path resolution for `fortls` and formatters](#added-relative-path-resolution-for-fortls-and-formatters)
  - [Added variable resolution support for `fortls`](#added-variable-resolution-support-for-fortls)
  - [Added `fpm.toml` schema validation](#added-fpmtoml-schema-validation)
  - [Improved Installation of dependencies using VS Code Tasks](#improved-installation-of-dependencies-using-vs-code-tasks)
  - [New Commands](#new-commands)
    - [`Fortran: Initialize Fortran Linter`](#fortran-initialize-fortran-linter)
    - [`Fortran: Clean Linter generated files`](#fortran-clean-linter-generated-files)
    - [`Fortran: Clean All Linter Diagnostics`](#fortran-clean-all-linter-diagnostics)
  - [New Settings](#new-settings)
    - [Hide Release Notes `fortran.notifications.releaseNotes`](#hide-release-notes-fortrannotificationsreleasenotes)
    - [Linter Initialization `fortran.linter.initialize`](#linter-initialization-fortranlinterinitialize)
    - [Cleaning Diagnostics `fortran.experimental.keepInitDiagnostics`](#cleaning-diagnostics-fortranexperimentalkeepinitdiagnostics)
    - [Log Channel Verbosity `fortran.logging.level`](#log-channel-verbosity-fortranlogginglevel)
- [Other Changes](#other-changes)
  - [Improved performance of the linter](#improved-performance-of-the-linter)
  - [Update native symbol provider](#update-native-symbol-provider)
  - [Changed Linter glob resolution module to `glob` from `fast-glob`](#changed-linter-glob-resolution-module-to-glob-from-fast-glob)
- [üêõ Bug Fixes üêõ](#-bug-fixes-)

## Linter

### `fypp` support

Adds some initial support for `fypp` when using `gfortran`. More compilers will follow soon!

![image](https://user-images.githubusercontent.com/16143716/190215420-085043a5-8250-4777-a0f0-7a94ec740987.png)

### Improved diagnostics for GNU Fortran

Added support for parsing plain text diagnostics from `gfortran` v11+
thus allowing the display of multiline diagnostics

```fortran
module err_mod
    private
    implicit none   ! <- Error here previously not shown
    contains
        subroutine foo(arg1, arg2)
            integer, intent(in) :: arg1, arg2
            print*, 'arg1:', arg1, 'arg2:', arg2
        end subroutine foo
        subroutine proc_with_err()
            call foo()
        end subroutine proc_with_err
end module err_mod
```

![image](https://user-images.githubusercontent.com/16143716/190216547-324a70c3-df57-4c13-800d-efbd57b52562.png)

### LFortran Linter support

The LFortran linter is now available in the extension. It can be enabled by setting the `fortran.linter.compiler` setting to `lfortran`.

### Persistent Cache

By default, now the linter uses a unique VS Code, workspace specific persistent cache directory to store all output files generated by the linter. This should prevent
any unexpected behaviour where the linter produces unwanted `.mod` files that
are then picked up by the build system.

You can clean the cache by running the `Fortran: Clean Linter generated files` command, see [Commands](#commands) for more details.

### Commands

A series of new commands have been added, see [**New Commands**](#new-commands) section for more details.

- `Fortran: Initialize Fortran Linter`
- `Fortran: Clean Linter generated files`
- `Fortran: Clean All Linter Diagnostics`

## User Interface (UI)

### Run and Debug individual files

You can now run and debug individual files. This is useful for debugging small snippets of code. To do this, right-click on the file and select `Run File` or `Debug File` from the context menu.

### Log Channel improvements

The `Modern Fortran` log channel has had a small revamp.
Logs are now colourized to make reading them easier

![image](https://user-images.githubusercontent.com/16143716/190214202-0cce3ee4-80da-4f4a-88bb-c36abd09c8f6.png)

### Setting verbosity level

You can now choose the verbosity level of the extension by setting the following option in the settings

```json
{
  "fortran.logging.level": "Error"
}
```

### Added Fortran Logo icon

Added a new icon for the Fortran Language files

![image](https://user-images.githubusercontent.com/16143716/192509653-609b25c2-f1bb-4370-ba2d-2781d7505814.png)

### Added relative path resolution for `fortls` and formatters

It is now possible to define the path to `fortls` or the formatters using relative
paths to the top-most workspace folder.

```json
"fortran.fortls.path": "./venv/bin/fortls"
```

### Added variable resolution support for `fortls`

Previously, internal VS Code variables like `${workspaceFolder}` were not resolved
when defining the path to `fortls`. This has now been fixed.

```json
"fortran.fortls.path": "${workspaceFolder}/venv/bin/fortls"
```

### Added `fpm.toml` schema validation

Leveraging the support for schemas from the Even Better TOML extension,
Modern Fortran now provides a schema for `fpm.toml` file validation and autocompletion.

![fpm-toml-validation](https://user-images.githubusercontent.com/16143716/194323699-79d0e598-fdf4-4c9c-9c56-3b9201a70824.gif)

### Improved Installation of dependencies using VS Code Tasks

The extension dependencies are now installed using Visual Studio Code's Tasks. That means that the commands are run from within the VS Code terminal, inheriting any environment variables already present. Particularly useful when using Python virtual environments.

### New Commands

A series of new commands have been added for the linter

#### `Fortran: Initialize Fortran Linter`

Runs a naive mock compilation of all the Fortran source files found in the project
in order to generate the `.mod` and `.smod` files necessary for the linter. This
also generates all the Diagnostics for the project.

#### `Fortran: Clean Linter generated files`

Cleans all the `.mod` and `.smod` files generated by the linter that are placed
in the persistent cache storage of VS Code for this workspace.

#### `Fortran: Clean All Linter Diagnostics`

Cleans all the diagnostics generated by the linter.

### New Settings

#### Hide Release Notes `fortran.notifications.releaseNotes`

Hide release notes when the extension in being installed or updated.

```json
"fortran.notifications.releaseNotes": true
```

#### Linter Initialization `fortran.linter.initialize`

An option, by default `true` that will attempt to initialize the linter with
all the Fortran source files found in the workspace upon the extension activation.

Performs the same task as the `Fortran: Initialize Fortran Linter` command.

#### Cleaning Diagnostics `fortran.experimental.keepInitDiagnostics`

An option to keep or discard all the diagnostics generated by running the
initialization process of the linter.

#### Log Channel Verbosity `fortran.logging.level`

An option to set the verbosity level of the extension log channel.

## Other Changes

### Improved performance of the linter

Converted the linter into using asynchronous processes, which should improve the overall performance and responsiveness of the diagnostics.

### Update native symbol provider

The native symbol provider (one used when `fortls` is not present) has been updated
to use the new VS Code API.

### Changed Linter glob resolution module to `glob` from `fast-glob`

The `fast-glob` module was causing issues with the linter when using the `**` glob pattern. The parent directory would not be included in the results see, <https://github.com/mrmlnc/fast-glob/issues/47>.

This was problematic since users had to define the include directories twice,
once with the glob pattern and once without it. We have switched to the `glob`,
which is slower but does not suffer from this issue.

The cache used by the linter should help mitigate any performance issues.

## üêõ Bug Fixes üêõ
